name: Integration Tests

on:
  pull_request:
    branches:
      - "**"
  push:
    branches:
      - main

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    services:
      ollama:
        image: ollama/ollama:latest
        ports:
          - 11434:11434
        env:
          OLLAMA_ALLOW_INSECURE: "true"
          OLLAMA_ALLOW_UNVERIFIED: "true"

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.6.10"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv sync --frozen

      - name: Wait for Ollama
        run: |
          echo "Waiting for Ollama service..."
          timeout 30s bash -c 'until curl -s http://localhost:11434/ > /dev/null; do sleep 1; done'

      - name: Pull Ollama Model
        run: |
          echo "Pulling llama3.2:1b..."
          # Use stream=false to wait for completion
          curl -X POST http://localhost:11434/api/pull -d '{"name": "llama3.2:1b", "stream": false}'

      - name: Install httpyac
        run: |
          sudo npm install -g httpyac --unsafe-perm=true

      # ── Phase 1: full.yaml ─────────────────────────────────────────────────
      - name: "[Phase 1] Start OpenGuard with full.yaml"
        env:
          OPENGUARD_OPENAI_URL_1: "http://localhost:11434/v1"
          OPENGUARD_OPENAI_KEY_1: "sk-ollama"
          OPENGUARD_PORT: "23294"
          OPENGUARD_CONFIG: "presets/full.yaml"
        run: |
          uv run uvicorn src.main:app --host 0.0.0.0 --port 23294 > openguard-phase1.log 2>&1 &
          echo "Waiting for OpenGuard (phase 1) to be healthy..."
          timeout 30s bash -c 'until curl -s http://localhost:23294/health > /dev/null; do sleep 1; done'

      - name: "[Phase 1] Run tests (all except agentic_llm_inspection)"
        run: |
          # Exclude agentic_llm_inspection.http — it requires agentic.yaml (phase 2)
          find http/tests -name "*.http" ! -name "agentic_llm_inspection.http" | sort | \
            xargs httpyac --all --output short

      - name: "[Phase 1] Stop OpenGuard"
        if: always()
        run: |
          pkill -f "uvicorn src.main" || true
          sleep 2

      # ── Phase 2: agentic.yaml ──────────────────────────────────────────────
      - name: "[Phase 2] Start OpenGuard with agentic.yaml"
        env:
          OPENGUARD_OPENAI_URL_1: "http://localhost:11434/v1"
          OPENGUARD_OPENAI_KEY_1: "sk-ollama"
          OPENGUARD_PORT: "23294"
          OPENGUARD_CONFIG: "presets/agentic.yaml"
        run: |
          uv run uvicorn src.main:app --host 0.0.0.0 --port 23294 > openguard-phase2.log 2>&1 &
          echo "Waiting for OpenGuard (phase 2) to be healthy..."
          timeout 30s bash -c 'until curl -s http://localhost:23294/health > /dev/null; do sleep 1; done'

      - name: "[Phase 2] Run agentic_llm_inspection tests"
        run: |
          httpyac http/tests/guards/agentic_llm_inspection.http --all --output short

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Phase 1 logs ==="
          cat openguard-phase1.log || true
          echo "=== Phase 2 logs ==="
          cat openguard-phase2.log || true
