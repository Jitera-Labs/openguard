# @import ../../variables.http
# @import ../../helpers.http

### 1. Block AWS Access Key ID
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Store this credential: AKIAIOSFODNN7EXAMPLE"
    }
  ]
}

?? status == 403
{{
  test('AWS Access Key ID should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 2. Block AWS Secret Access Key
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Here is my secret key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    }
  ]
}

?? status == 403
{{
  test('AWS Secret Access Key should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 3. Block Private Key header
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0B\n-----END PRIVATE KEY-----"
    }
  ]
}

?? status == 403
{{
  test('Private Key header should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 4. Block RSA Private Key header
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "-----BEGIN RSA PRIVATE KEY-----\nMIIEowIBAAKCAQEA2a2rwplBQL\n-----END RSA PRIVATE KEY-----"
    }
  ]
}

?? status == 403
{{
  test('RSA Private Key header should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 5. Block GitHub Personal Access Token
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Use this token: ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghij"
    }
  ]
}

?? status == 403
{{
  test('GitHub PAT should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 6. Block Slack Bot Token (xoxb-)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Slack bot token: xoxb-1234567890-abcdefghijklmno"
    }
  ]
}

?? status == 403
{{
  test('Slack bot token (xoxb-) should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 7. Block Slack User Token (xoxp-)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "My Slack token is xoxp-9876543210-abcdefghij"
    }
  ]
}

?? status == 403
{{
  test('Slack user token (xoxp-) should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 8. Block secret in multi-turn conversation
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "system",
      "content": "You are a helpful assistant."
    },
    {
      "role": "user",
      "content": "Can you help me deploy my app?"
    },
    {
      "role": "assistant",
      "content": "Sure, I need your AWS credentials."
    },
    {
      "role": "user",
      "content": "Here: AKIAIOSFODNN7EXAMPLE"
    }
  ]
}

?? status == 403
{{
  test('Secret in multi-turn conversation should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 9. Block secret in multimodal content array
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "Please review my config: ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghij"
        }
      ]
    }
  ]
}

?? status == 403
{{
  test('Secret in multimodal content should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 10. Allow normal coding request
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Write a Python function to sort a list of integers."
    }
  ]
}

?? status == 200
{{
  test('Normal coding request should be allowed', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 11. Allow short uppercase string (not 20 chars)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "My ID is ABCDEF1234 and it is short."
    }
  ]
}

?? status == 200
{{
  test('Short uppercase string should not trigger AWS key pattern', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 12. Allow uppercase GHP_ prefix (case-sensitive mismatch)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "The prefix GHP_ is used in documentation but GHP_abcdefghijklmnopqrstuvwxyz1234567890 is uppercase prefix so won't match ghp_ pattern."
    }
  ]
}

?? status == 200
{{
  test('Uppercase GHP_ prefix should not match case-sensitive ghp_ pattern', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 13. Allow text with BEGIN and KEY words separately
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Let us BEGIN the discussion about the KEY concepts of cryptography."
    }
  ]
}

?? status == 200
{{
  test('Words BEGIN and KEY separately should not trigger private key pattern', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 14. Block AWS key embedded in JSON config snippet
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Here's my config: {\"aws_access_key_id\": \"AKIAIOSFODNN7EXAMPLE\", \"region\": \"us-east-1\"}"
    }
  ]
}

?? status == 403
{{
  test('AWS key inside JSON config should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 15. Block both AWS key and secret in env file content
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE\nAWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
    }
  ]
}

?? status == 403
{{
  test('Both AWS secrets in env file content should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 16. Block GitHub PAT inside git clone URL
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Run this: git clone https://ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghij@github.com/user/repo.git"
    }
  ]
}

?? status == 403
{{
  test('GitHub PAT inside git clone URL should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 17. Block private key inside markdown code fence
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Here's my cert:\n```\n-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAAOCAQ8A\n-----END PRIVATE KEY-----\n```"
    }
  ]
}

?? status == 403
{{
  test('Private key inside markdown code fence should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 18. Block Slack token inside curl command
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "curl -H \"Authorization: Bearer xoxb-123456789012-abcdefghijklmn\" https://slack.com/api/chat.postMessage"
    }
  ]
}

?? status == 403
{{
  test('Slack token inside curl command should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 19. Block AWS key at the end of a multi-paragraph message
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "I have been trying to set up my infrastructure for hours now. The documentation is really confusing and I keep getting permission errors.\n\nI tried changing IAM policies but nothing worked. Can you please take a look at my setup?\n\nMy access key is AKIAIOSFODNN7EXAMPLE"
    }
  ]
}

?? status == 403
{{
  test('AWS key at end of multi-paragraph message should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 20. Allow AWS key pattern embedded in longer uppercase run (lookbehind/lookahead fail)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Our variable is named THISLONGVARIABLENAMEAKIAIOSFODNN7EXAMPLEMORE in the codebase."
    }
  ]
}

?? status == 200
{{
  test('20-char pattern inside longer uppercase run should not match due to lookaround', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 21. Allow exactly 19-char uppercase string (one char short of AWS key pattern)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Reference code: ABCDEFGHIJ123456789 is only 19 characters."
    }
  ]
}

?? status == 200
{{
  test('19-char uppercase string should not match 20-char AWS key pattern', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 22. Allow exactly 21-char uppercase string (lookahead prevents match)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Reference code: ABCDEFGHIJ12345678901 is 21 contiguous uppercase chars."
    }
  ]
}

?? status == 200
{{
  test('21-char contiguous uppercase string should not match due to lookahead failure', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 23. Block exactly 20-char uppercase string surrounded by spaces
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "The identifier is ABCDEFGHIJ1234567890 and it should be flagged."
    }
  ]
}

?? status == 403
{{
  test('Exactly 20-char uppercase string with non-alnum boundaries should be blocked', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 24. Allow GitHub PAT with only 35 chars after ghp_ (one short)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Token: ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghi"
    }
  ]
}

?? status == 200
{{
  test('GitHub PAT with 35 chars after prefix should not match 36-char pattern', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}

### 25. Block GitHub PAT with 37 chars after ghp_ (regex matches first 36)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "Token: ghp_ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijk"
    }
  ]
}

?? status == 403
{{
  test('GitHub PAT with 37 alphanumeric chars should still match (regex finds first 36)', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 26. Block Slack app-level token with xoxs- prefix
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "App token: xoxs-1234567890abcd"
    }
  ]
}

?? status == 403
{{
  test('Slack xoxs- token should be blocked (s is in [baprs])', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 27. Block AWS key after equals sign in commented env line
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "# export AWS_KEY=AKIAIOSFODNN7EXAMPLE"
    }
  ]
}

?? status == 403
{{
  test('AWS key after = sign in comment should be blocked (= not in [A-Z0-9])', () => {
    expect(response.parsedBody.error).toBeDefined("Error object should exist");
    expect(response.parsedBody.error.message.toLowerCase()).toInclude("blocked", "Should indicate request was blocked");
  });
}}

### 28. Allow BEGIN EC PRIVATE KEY header (not matched by either private key pattern)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "messages": [
    {
      "role": "user",
      "content": "-----BEGIN EC PRIVATE KEY-----\nMHQCAQEEIBkg5C3hAp3MkHI3l2Ewz8rV\n-----END EC PRIVATE KEY-----"
    }
  ]
}

?? status == 200
{{
  test('EC PRIVATE KEY header should not match PRIVATE KEY or RSA PRIVATE KEY patterns', () => {
    expect(response.parsedBody.choices).toBeDefined("Response should have choices");
  });
}}