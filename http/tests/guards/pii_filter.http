# @import ../../variables.http
# @import ../../helpers.http

### 1. Email Redaction
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: test.user@example.co.uk"
    }
  ]
}

?? status == 200
{{
  test('Email should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('test.user@example.co.uk', "Original email was leaked");
    expect(content).toInclude('<protected:email>', "Redaction marker <protected:email> not found");
  });
}}

### 2. Phone Redaction (Format: Dashes)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: 555-012-3456"
    }
  ]
}

?? status == 200
{{
  test('Phone (dashes) should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('555-012-3456', "Original phone number was leaked");
    expect(content).toInclude('<protected:phone>', "Redaction marker <protected:phone> not found");
  });
}}

### 3. Phone Redaction (Format: Dots)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: 555.012.3456"
    }
  ]
}

?? status == 200
{{
  test('Phone (dots) should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('555.012.3456', "Original phone number was leaked");
    expect(content).toInclude('<protected:phone>', "Redaction marker <protected:phone> not found");
  });
}}

### 4. SSN Redaction
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: 123-45-6789"
    }
  ]
}

?? status == 200
{{
  test('SSN should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('123-45-6789', "Original SSN was leaked");
    const hasMarker = content.includes('<protected:ssn>');
    const hasRefusal = content.toLowerCase().includes('personal identification')
      || content.toLowerCase().includes("can't provide");
    expect(hasMarker || hasRefusal).toBeTruthy("Expected SSN redaction marker or refusal response");
  });
}}

### 5. Credit Card Redaction (Format: Dashes)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: 4532-1234-5678-9012"
    }
  ]
}

?? status == 200
{{
  test('Credit card (dashes) should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('4532-1234-5678-9012', "Original credit card was leaked");
    expect(content).toInclude('<protected:creditcard>', "Redaction marker <protected:creditcard> not found");
  });
}}

### 6. Credit Card Redaction (Format: Spaces)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: 4532 1234 5678 9012"
    }
  ]
}

?? status == 200
{{
  test('Credit card (spaces) should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('4532 1234 5678 9012', "Original credit card was leaked");
    expect(content).toInclude('<protected:creditcard>', "Redaction marker <protected:creditcard> not found");
  });
}}

### 7. Mixed PII Types
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: mixed@example.com and 987-654-3210"
    }
  ]
}

?? status == 200
{{
  test('Mixed PII should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('mixed@example.com', "Original email was leaked");
    expect(content).not.toInclude('987-654-3210', "Original phone was leaked");
    expect(content).toInclude('<protected:email>', "Email marker not found");
    expect(content).toInclude('<protected:phone>', "Phone marker not found");
  });
}}

### 8. Multiple Occurrences of Same PII Type
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": "Repeat exactly this text and nothing else: alice@example.com bob@example.org"
    }
  ]
}

?? status == 200
{{
  test('Multiple emails should all be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('alice@example.com', "First email leaked");
    expect(content).not.toInclude('bob@example.org', "Second email leaked");

    // Check count of markers using regex match
    const matches = content.match(/<protected:email>/g);
    expect(matches && matches.length >= 2).toBeTruthy("Should find at least 2 email protection markers");
  });
}}

### 9. Multimodal Content (Array)
POST {{host}}/v1/chat/completions
...defaultHeaders

{
  "model": "{{model}}",
  "temperature": 0,
  "messages": [
    {
      "role": "user",
      "content": [
        {
          "type": "text",
          "text": "Repeat exactly this text and nothing else: backup@example.org"
        }
      ]
    }
  ]
}

?? status == 200
{{
  test('Email in structured content should be redacted', () => {
    const content = response.parsedBody.choices[0].message.content;
    expect(content).not.toInclude('backup@example.org', "Original email in structured content was leaked");
    expect(content).toInclude('<protected:email>', "Redaction marker not found in structured content response");
  });
}}
